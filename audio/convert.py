# ä¼ ç»ŸåŠŸèƒ½å®ç°å‡½æ•°
import wave
from pydub import AudioSegment

# 1. éŸ³é¢‘wavè½¬åŒ–æˆpcm
def convert_wav_to_pcm(wav_path, pcm_path):
    try:
        with wave.open(wav_path, 'rb') as wav:
            if wav.getsampwidth() == 2 and wav.getframerate() == 16000 and wav.getnchannels() == 1:
                # å¦‚æœ WAV æ ¼å¼ç¬¦åˆè¦æ±‚ï¼Œç›´æ¥å¤åˆ¶æ•°æ®
                with open(pcm_path, 'wb') as pcm:
                    pcm.write(wav.readframes(wav.getnframes()))
            else:
                # å¦‚æœ WAV æ ¼å¼ä¸ç¬¦åˆè¦æ±‚ï¼Œä½¿ç”¨ pydub è¿›è¡Œè½¬æ¢
                audio = AudioSegment.from_wav(wav_path)
                audio = audio.set_frame_rate(16000).set_sample_width(2).set_channels(1)
                with open(pcm_path, 'wb') as pcm:
                    pcm.write(audio.raw_data)
    except Exception as e:
        print(f"è½¬æ¢è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {e}")

# 1. æ ¹æ®è¯„åˆ†ç›´æ¥ç”Ÿæˆåé¦ˆï¼ˆä¸è°ƒç”¨AIè§£æï¼‰
def generate_feedback_history(scores, text):
    """æ ¹æ®è¯„åˆ†ç›´æ¥ç”Ÿæˆåé¦ˆå»ºè®®ï¼ˆçº¯é€»è¾‘åˆ¤æ–­ï¼Œä¸è°ƒç”¨AIï¼‰"""
    feedback = {
        "ğŸŒŸ èƒ½åŠ›ç‚¹è¯„": [],
        "ğŸ“ˆ æ”¹è¿›å»ºè®®": []
    }

    # èƒ½åŠ›ç‚¹è¯„ï¼ˆè‚¯å®šé«˜åˆ†é¡¹ï¼‰
    if scores["è¯­è¨€è¡¨è¾¾èƒ½åŠ›"] >= 85:
        feedback["ğŸŒŸ èƒ½åŠ›ç‚¹è¯„"].append("è¯­è¨€è¡¨è¾¾æµç•…è‡ªç„¶ï¼Œé€»è¾‘æ€§å¼º")
    if scores["é€»è¾‘æ€ç»´èƒ½åŠ›"] >= 85:
        feedback["ğŸŒŸ èƒ½åŠ›ç‚¹è¯„"].append("é€»è¾‘æ¸…æ™°ï¼Œè®ºè¯æœ‰æ¡ç†")
    if scores["ä¸“ä¸šçŸ¥è¯†æ°´å¹³"] >= 85:
        feedback["ğŸŒŸ èƒ½åŠ›ç‚¹è¯„"].append("ä¸“ä¸šçŸ¥è¯†æ‰å®ï¼Œç¬¦åˆå²—ä½è¦æ±‚")
    if scores["æŠ€èƒ½åŒ¹é…åº¦"] >= 85:
        feedback["ğŸŒŸ èƒ½åŠ›ç‚¹è¯„"].append("æŠ€èƒ½ä¸å²—ä½éœ€æ±‚é«˜åº¦åŒ¹é…ï¼Œæ¡ˆä¾‹ä¸°å¯Œ")
    if scores["åº”å˜æŠ—å‹ä¸åˆ›æ–°èƒ½åŠ›"] >= 85:
        feedback["ğŸŒŸ èƒ½åŠ›ç‚¹è¯„"].append("åº”å¯¹å‹åŠ›å’Œçªå‘é—®é¢˜çš„èƒ½åŠ›å¼ºï¼Œæœ‰åˆ›æ–°æ€ç»´")

    # æ”¹è¿›å»ºè®®ï¼ˆé’ˆå¯¹ä¸­ç­‰åˆ†æ•°æ®µï¼‰
    if 60 <= scores["è¯­è¨€è¡¨è¾¾èƒ½åŠ›"] < 85:
        feedback["ğŸ“ˆ æ”¹è¿›å»ºè®®"].append("å¯è¿›ä¸€æ­¥æé«˜è¯­è¨€ç®€æ´æ€§ï¼Œå‡å°‘ä¸å¿…è¦çš„é‡å¤")
    if 60 <= scores["é€»è¾‘æ€ç»´èƒ½åŠ›"] < 85:
        feedback["ğŸ“ˆ æ”¹è¿›å»ºè®®"].append("å»ºè®®ä½¿ç”¨ã€Œé¦–å…ˆ...å…¶æ¬¡...æœ€åã€ç­‰è¿æ¥è¯å¢å¼ºé€»è¾‘æ€§")
    if 60 <= scores["ä¸“ä¸šçŸ¥è¯†æ°´å¹³"] < 85:
        feedback["ğŸ“ˆ æ”¹è¿›å»ºè®®"].append("éœ€è¡¥å……è¯¥é¢†åŸŸæ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼Œç»“åˆå²—ä½éœ€æ±‚æ·±åŒ–ç†è§£")
    if 60 <= scores["æŠ€èƒ½åŒ¹é…åº¦"] < 85:
        feedback["ğŸ“ˆ æ”¹è¿›å»ºè®®"].append("å¯å¤šæåŠä¸å²—ä½è¦æ±‚ç›´æ¥ç›¸å…³çš„æŠ€èƒ½å’Œé¡¹ç›®ç»éªŒ")
    if 60 <= scores["åº”å˜æŠ—å‹ä¸åˆ›æ–°èƒ½åŠ›"] < 85:
        feedback["ğŸ“ˆ æ”¹è¿›å»ºè®®"].append("å¯å¢åŠ åº”å¯¹çªå‘é—®é¢˜çš„æ¡ˆä¾‹ï¼Œå±•ç¤ºçµæ´»åº”å˜èƒ½åŠ›")

    # é‡ç‚¹æ”¹è¿›ï¼ˆé’ˆå¯¹ä½åˆ†æ®µï¼‰
    if scores["è¯­è¨€è¡¨è¾¾èƒ½åŠ›"] < 60:
        feedback["ğŸ“ˆ æ”¹è¿›å»ºè®®"].append("âš ï¸ è¯­è¨€è¡¨è¾¾è¿è´¯æ€§ä¸è¶³ï¼Œå»ºè®®é€šè¿‡å¤è¿°ç»ƒä¹ æé«˜æµç•…åº¦")
    if scores["é€»è¾‘æ€ç»´èƒ½åŠ›"] < 60:
        feedback["ğŸ“ˆ æ”¹è¿›å»ºè®®"].append("âš ï¸ é€»è¾‘ç»“æ„ä¸æ¸…æ™°ï¼Œå»ºè®®ç”¨æ€ç»´å¯¼å›¾æ¢³ç†å›ç­”æ¡†æ¶")
    if scores["ä¸“ä¸šçŸ¥è¯†æ°´å¹³"] < 60:
        feedback["ğŸ“ˆ æ”¹è¿›å»ºè®®"].append("âš ï¸ ä¸“ä¸šçŸ¥è¯†è–„å¼±ï¼Œå»ºè®®ç³»ç»Ÿå­¦ä¹ è¯¥é¢†åŸŸæ ¸å¿ƒçŸ¥è¯†ä½“ç³»")
    if scores["æŠ€èƒ½åŒ¹é…åº¦"] < 60:
        feedback["ğŸ“ˆ æ”¹è¿›å»ºè®®"].append("âš ï¸ æŠ€èƒ½ä¸å²—ä½éœ€æ±‚ä¸åŒ¹é…ï¼Œå»ºè®®é’ˆå¯¹æ€§æå‡ç›¸å…³æŠ€èƒ½")
    if scores["åº”å˜æŠ—å‹ä¸åˆ›æ–°èƒ½åŠ›"] < 60:
        feedback["ğŸ“ˆ æ”¹è¿›å»ºè®®"].append("âš ï¸ åº”å˜èƒ½åŠ›ä¸è¶³ï¼Œå»ºè®®é€šè¿‡æ¨¡æ‹Ÿå‹åŠ›é¢è¯•åœºæ™¯åŠ å¼ºè®­ç»ƒ")

    # é’ˆå¯¹æå·®åˆ†æ•°ï¼ˆ<50ï¼‰çš„é¢å¤–å»ºè®®
    if scores["è¯­è¨€è¡¨è¾¾èƒ½åŠ›"] < 30:
        feedback["ğŸ“ˆ æ”¹è¿›å»ºè®®"].append("ğŸš¨ è¯­è¨€è¡¨è¾¾ç»´åº¦è¾ƒå·®ï¼Œå»ºè®®æ¯æ—¥è¿›è¡Œå³å…´æ¼”è®²ç»ƒä¹ ")
    if scores["é€»è¾‘æ€ç»´èƒ½åŠ›"] < 30:
        feedback["ğŸ“ˆ æ”¹è¿›å»ºè®®"].append("ğŸš¨ é€»è¾‘æ€ç»´ç»´åº¦è¾ƒå·®ï¼Œæ¨èå­¦ä¹ ã€Šé‡‘å­—å¡”åŸç†ã€‹æå‡ç»“æ„åŒ–è¡¨è¾¾")
    if scores["ä¸“ä¸šçŸ¥è¯†æ°´å¹³"] < 30:
        feedback["ğŸ“ˆ æ”¹è¿›å»ºè®®"].append("ğŸš¨ ä¸“ä¸šçŸ¥è¯†ç»´åº¦è¾ƒå·®ï¼Œå»ºè®®æŠ¥åç›¸å…³åŸ¹è®­è¯¾ç¨‹ç³»ç»Ÿå­¦ä¹ ")
    if scores["æŠ€èƒ½åŒ¹é…åº¦"] < 30:
        feedback["ğŸ“ˆ æ”¹è¿›å»ºè®®"].append("ğŸš¨ æŠ€èƒ½åŒ¹é…åº¦ç»´åº¦è¾ƒå·®ï¼Œå»ºè®®è€ƒå–ç›¸å…³ä¸“ä¸šè®¤è¯")
    if scores["åº”å˜æŠ—å‹ä¸åˆ›æ–°èƒ½åŠ›"] < 30:
        feedback["ğŸ“ˆ æ”¹è¿›å»ºè®®"].append("ğŸš¨ åº”å˜èƒ½åŠ›ç»´åº¦è¾ƒå·®ï¼Œå¯é€šè¿‡è§’è‰²æ‰®æ¼”æ¨¡æ‹Ÿé¢è¯•åœºæ™¯è®­ç»ƒ")

    # æ€»ä½“å»ºè®®
    low_dimensions = [dim for dim, score in scores.items() if score < 60]
    if len(low_dimensions) >= 3:
        feedback["ğŸ“ˆ æ”¹è¿›å»ºè®®"].append("ğŸ’¡ å¤šä¸ªèƒ½åŠ›ç»´åº¦éœ€è¦æå‡ï¼Œå»ºè®®å…ˆä»ä¸“ä¸šçŸ¥è¯†å’ŒæŠ€èƒ½åŒ¹é…åº¦å…¥æ‰‹")
        feedback["ğŸ“ˆ æ”¹è¿›å»ºè®®"].append("ğŸ’¡ å¯ä½¿ç”¨æœ¬ç³»ç»Ÿçš„æ¨¡æ‹Ÿé¢è¯•åŠŸèƒ½ï¼Œé’ˆå¯¹æ€§è®­ç»ƒè–„å¼±ç¯èŠ‚")

    # å¤„ç†ç©ºç‚¹è¯„/å»ºè®®çš„æƒ…å†µ
    if not feedback["ğŸŒŸ èƒ½åŠ›ç‚¹è¯„"]:
        feedback["ğŸŒŸ èƒ½åŠ›ç‚¹è¯„"].append("å„ç»´åº¦è¡¨ç°ä¸­ç­‰ï¼Œéœ€è¿›ä¸€æ­¥æå‡ä¼˜åŠ¿é¡¹")
    if not feedback["ğŸ“ˆ æ”¹è¿›å»ºè®®"]:
        feedback["ğŸ“ˆ æ”¹è¿›å»ºè®®"].append("æ•´ä½“è¡¨ç°ä¼˜ç§€ï¼Œå¯ä¿æŒå½“å‰çŠ¶æ€å¹¶æŒç»­ä¼˜åŒ–ç»†èŠ‚")

    return feedback


from typing import Dict, List

# å…¨å±€é…ç½®ï¼šåˆ†æ•°æ¡£åˆ’åˆ†ï¼ˆ0-100åˆ†ï¼‰
SCORE_LEVELS = {
    "ä¼˜ç§€": (80, 100),  # 80-100åˆ†
    "è‰¯å¥½": (60, 79),  # 60-79åˆ†
    "ä¸€èˆ¬": (40, 59),  # 40-59åˆ†
    "è¾ƒå·®": (0, 39)  # 0-39åˆ†
}

# ç¦»çº¿å»ºè®®æ¨¡æ¿ï¼ˆæŒ‰ç»´åº¦å’Œåˆ†æ•°æ¡£é¢„è®¾ï¼‰
FEEDBACK_TEMPLATES = {
    # 1. å›ç­”æ­£ç¡®æ€§æ¨¡æ¿ï¼ˆåŸºäºæ˜¯å¦åŒ¹é…é—®é¢˜æ ¸å¿ƒï¼‰
    "å›ç­”æ­£ç¡®æ€§": {
        "ä¼˜ç§€": ["1. å›ç­”å®Œå…¨æ­£ç¡®ï¼Œç²¾å‡†è¦†ç›–é—®é¢˜æ ¸å¿ƒè¦ç‚¹ï¼Œé€»è¾‘ä¸¥è°¨ã€‚", "2. å¯¹é—®é¢˜çš„ç†è§£é€å½»ï¼ŒæŠ€æœ¯ç»†èŠ‚æè¿°å‡†ç¡®ã€‚"],
        "è‰¯å¥½": ["1. å›ç­”åŸºæœ¬æ­£ç¡®ï¼Œä½†éƒ¨åˆ†ç»†èŠ‚ä¸å¤Ÿå®Œå–„ã€‚", "2. å¯¹é—®é¢˜çš„æ ¸å¿ƒæ¦‚å¿µæœ‰æ­£ç¡®ç†è§£ï¼Œä½†å±•å¼€ä¸å¤Ÿå……åˆ†ã€‚"],
        "ä¸€èˆ¬": ["1. å›ç­”éƒ¨åˆ†æ­£ç¡®ï¼Œå­˜åœ¨æ¦‚å¿µæ¨¡ç³Šæˆ–ç†è§£åå·®ã€‚", "2. æœªå®Œå…¨æŠ“ä½é—®é¢˜æ ¸å¿ƒï¼Œéœ€åŠ å¼ºå¯¹é—®é¢˜çš„åˆ†æèƒ½åŠ›ã€‚"],
        "è¾ƒå·®": ["1. å›ç­”é”™è¯¯æˆ–å®Œå…¨åç¦»é—®é¢˜æ ¸å¿ƒã€‚", "2. æœªç†è§£é—®é¢˜æœ¬è´¨ï¼Œéœ€é‡æ–°å­¦ä¹ ç›¸å…³åŸºç¡€æ¦‚å¿µã€‚"]
    },
    # 2. èƒ½åŠ›ç‚¹è¯„æ¨¡æ¿ï¼ˆæŒ‰æŠ€æœ¯å²—æ ¸å¿ƒèƒ½åŠ›ï¼‰
    "èƒ½åŠ›ç‚¹è¯„": {
        "ä¼˜ç§€": ["1. ä¸“ä¸šçŸ¥è¯†æ‰å®ï¼ŒæŠ€æœ¯æœ¯è¯­ä½¿ç”¨å‡†ç¡®ã€‚", "2. é€»è¾‘æ¸…æ™°ï¼Œè¡¨è¾¾æµç•…ï¼Œå²—ä½åŒ¹é…åº¦é«˜ã€‚"],
        "è‰¯å¥½": ["1. å…·å¤‡åŸºç¡€ä¸“ä¸šçŸ¥è¯†ï¼Œèƒ½åº”å¯¹å¸¸è§„æŠ€æœ¯é—®é¢˜ã€‚", "2. é€»è¾‘åŸºæœ¬æ¸…æ™°ï¼Œéœ€æå‡å¤æ‚é—®é¢˜çš„åˆ†æèƒ½åŠ›ã€‚"],
        "ä¸€èˆ¬": ["1. ä¸“ä¸šçŸ¥è¯†å­˜åœ¨æ¼æ´ï¼Œæ ¸å¿ƒæ¦‚å¿µæŒæ¡ä¸ç‰¢å›ºã€‚", "2. é€»è¾‘ä¸å¤Ÿè¿è´¯ï¼Œè¡¨è¾¾ç¼ºä¹å±‚æ¬¡æ„Ÿã€‚"],
        "è¾ƒå·®": ["1. ä¸“ä¸šçŸ¥è¯†è–„å¼±ï¼Œå­˜åœ¨æ˜æ˜¾çŸ¥è¯†ç›²åŒºã€‚", "2. é€»è¾‘æ··ä¹±ï¼Œæ— æ³•æ¸…æ™°è¡¨è¾¾è§‚ç‚¹ï¼Œå²—ä½åŒ¹é…åº¦ä½ã€‚"]
    },
    # 3. æ”¹è¿›å»ºè®®æ¨¡æ¿ï¼ˆåˆ†æ¡£ç»™å‡ºå¯æ“ä½œæ–¹æ³•ï¼‰
    "æ”¹è¿›å»ºè®®": {
        "ä¼˜ç§€": ["1. ä¿æŒç°æœ‰å­¦ä¹ èŠ‚å¥ï¼Œå¯æ·±å…¥ç ”ç©¶é¢†åŸŸå‰æ²¿æŠ€æœ¯ã€‚", "2. å°è¯•å°†çŸ¥è¯†åº”ç”¨åˆ°å¤æ‚é¡¹ç›®ä¸­ï¼Œæå‡å®æˆ˜èƒ½åŠ›ã€‚"],
        "è‰¯å¥½": ["1. é’ˆå¯¹è–„å¼±çŸ¥è¯†ç‚¹è¿›è¡Œä¸“é¡¹ç»ƒä¹ ï¼Œå¼ºåŒ–ç†è§£ã€‚", "2. å¤šå‚ä¸æŠ€æœ¯è®¨è®ºï¼Œæå‡è¡¨è¾¾çš„ä¸¥è°¨æ€§ã€‚"],
        "ä¸€èˆ¬": ["1. ç³»ç»Ÿå­¦ä¹ åŸºç¡€ç†è®ºï¼Œæ„å»ºçŸ¥è¯†æ¡†æ¶ã€‚", "2. ç»ƒä¹ ç»“æ„åŒ–è¡¨è¾¾ï¼ŒæŒ‰â€œé—®é¢˜-åˆ†æ-ç»“è®ºâ€æ¡†æ¶ç»„ç»‡æ€è·¯ã€‚"],
        "è¾ƒå·®": ["1. ä»åŸºç¡€æ¦‚å¿µå¼€å§‹å­¦ä¹ ï¼Œæ¨èå…¥é—¨æ•™æå’Œè¯¾ç¨‹ã€‚", "2. å…ˆæ¨¡ä»¿ä¼˜ç§€å›ç­”çš„ç»“æ„ï¼Œé€æ­¥å½¢æˆè‡ªå·±çš„é€»è¾‘ã€‚"]
    },
    # 4. æ¨èèµ„æºæ¨¡æ¿ï¼ˆåˆ†æ¡£æ¨èå­¦ä¹ ææ–™ï¼‰
    "æ¨èèµ„æº": {
        "ä¼˜ç§€": ["1. é¢†åŸŸé¡¶ä¼šè®ºæ–‡ï¼ˆå¦‚NeurIPSã€ICMLæœ€æ–°è®ºæ–‡ï¼‰ã€‚", "2. å¼€æºé¡¹ç›®æºç é˜…è¯»ï¼ˆå¦‚GitHubçƒ­é—¨ä»“åº“ï¼‰ã€‚"],
        "è‰¯å¥½": ["1. è¿›é˜¶æ•™æï¼ˆå¦‚ã€Šæ·±åº¦å­¦ä¹ è¿›é˜¶ã€‹ã€Šæœºå™¨å­¦ä¹ å®æˆ˜ã€‹ï¼‰ã€‚", "2. ä¸“ä¸šæŠ€æœ¯åšå®¢ï¼ˆå¦‚TowardsDataScienceã€æœºå™¨ä¹‹å¿ƒï¼‰ã€‚"],
        "ä¸€èˆ¬": ["1. åŸºç¡€æ•™æï¼ˆå¦‚ã€Šæ·±åº¦å­¦ä¹ å…¥é—¨ã€‹ã€Šæœºå™¨å­¦ä¹ åŸºç¡€ã€‹ï¼‰ã€‚", "2. åœ¨çº¿è¯¾ç¨‹ï¼ˆå¦‚Courseraå…¥é—¨è¯¾ç¨‹ã€Bç«™ç³»ç»Ÿè¯¾ï¼‰ã€‚"],
        "è¾ƒå·®": ["1. é›¶åŸºç¡€å…¥é—¨ä¹¦ç±ï¼ˆå¦‚ã€ŠPythonæ·±åº¦å­¦ä¹ ã€‹ã€Šæœºå™¨å­¦ä¹ é€šä¿—è§£é‡Šã€‹ï¼‰ã€‚", "2. å…¥é—¨è§†é¢‘æ•™ç¨‹ï¼ˆå¦‚MOOCåŸºç¡€è¯¾ã€èœé¸Ÿæ•™ç¨‹ï¼‰ã€‚"]
    }
}


def get_score_level(score: int) -> str:
    """æ ¹æ®åˆ†æ•°åˆ¤æ–­æ‰€å±æ¡£æ¬¡ï¼Œç¡®ä¿åˆ†æ•°åœ¨æœ‰æ•ˆèŒƒå›´å†…"""
    # é™åˆ¶åˆ†æ•°åœ¨0-100ä¹‹é—´ï¼Œé¿å…æ— æ•ˆåˆ†æ•°å¯¼è‡´çš„é”™è¯¯
    score = max(0, min(100, score))
    for level, (min_score, max_score) in SCORE_LEVELS.items():
        if min_score <= score <= max_score:
            return level
    return "è¾ƒå·®"  # é»˜è®¤æœ€ä½æ¡£


def generate_feedback_test(scores: Dict, text: str, domain: str, position: str, question: str = None) -> List:
    """
    ç¦»çº¿ç”Ÿæˆåé¦ˆï¼šåŸºäºåˆ†æ•°æ¡£è¿”å›ç»“æ„åŒ–å»ºè®®ï¼Œæ·»åŠ ç´¢å¼•å®‰å…¨æ£€æŸ¥
    """
    print(f"ç”Ÿæˆç¦»çº¿åé¦ˆï¼ˆé—®é¢˜ï¼š{question[:20]}...ï¼‰")
    feedback = []

    # ç¡®ä¿scoresä¸æ˜¯ç©ºå­—å…¸ï¼Œé¿å…åç»­å¤„ç†å‡ºé”™
    if not scores:
        scores = {"ä¸“ä¸šçŸ¥è¯†æ°´å¹³": 0}

    # 1. å›ç­”æ­£ç¡®æ€§ï¼ˆæ ¹æ®é—®é¢˜ä¸å›ç­”çš„åŒ¹é…åº¦è¯„åˆ†ï¼‰
    try:
        if len(text.strip()) < 20 or text.strip().lower() in ["ä¸çŸ¥é“", "æ²¡å­¦è¿‡", "ä¸æ¸…æ¥š"]:
            correctness_level = "è¾ƒå·®"
        else:
            # å®é™…åº”ç”¨ä¸­å¯æ ¹æ®å…³é”®è¯åŒ¹é…åº¦è®¡ç®—åˆ†æ•°
            correctness_level = get_score_level(scores.get("ä¸“ä¸šçŸ¥è¯†æ°´å¹³", 0))  # å¤ç”¨ä¸“ä¸šçŸ¥è¯†åˆ†æ•°æ¡£

        feedback.append("å›ç­”æ­£ç¡®æ€§")
        # å®‰å…¨è·å–æ¨¡æ¿å†…å®¹ï¼Œç¡®ä¿ç´¢å¼•æœ‰æ•ˆ
        if correctness_level in FEEDBACK_TEMPLATES["å›ç­”æ­£ç¡®æ€§"]:
            feedback.extend(FEEDBACK_TEMPLATES["å›ç­”æ­£ç¡®æ€§"][correctness_level])
        else:
            feedback.extend(FEEDBACK_TEMPLATES["å›ç­”æ­£ç¡®æ€§"]["è¾ƒå·®"])
        feedback.append("")  # ç« èŠ‚é—´ç©ºè¡Œ
    except Exception as e:
        feedback.append("å›ç­”æ­£ç¡®æ€§")
        feedback.append("1. æ— æ³•ç”Ÿæˆè¯„ä¼°ï¼Œå­˜åœ¨æ•°æ®é”™è¯¯")
        feedback.append("")
        print(f"å›ç­”æ­£ç¡®æ€§ç”Ÿæˆé”™è¯¯: {e}")

    # 2. èƒ½åŠ›ç‚¹è¯„ï¼ˆåŸºäºå„ç»´åº¦åˆ†æ•°ï¼‰
    try:
        feedback.append("èƒ½åŠ›ç‚¹è¯„")
        # å–æœ€ä½åˆ†çš„2ä¸ªç»´åº¦é‡ç‚¹ç‚¹è¯„ï¼Œç¡®ä¿è‡³å°‘æœ‰1ä¸ªç»´åº¦
        sorted_scores = sorted(scores.items(), key=lambda x: x[1])[:min(2, len(scores))]

        for i, (dim, score) in enumerate(sorted_scores, 1):
            level = get_score_level(score)
            # å®‰å…¨è®¿é—®æ¨¡æ¿ï¼Œç¡®ä¿åˆ—è¡¨ç´¢å¼•å­˜åœ¨
            if level in FEEDBACK_TEMPLATES["èƒ½åŠ›ç‚¹è¯„"] and FEEDBACK_TEMPLATES["èƒ½åŠ›ç‚¹è¯„"][level]:
                # åˆ†å‰²å­—ç¬¦ä¸²æ—¶ç¡®ä¿åŒ…å«åˆ†éš”ç¬¦
                template_parts = FEEDBACK_TEMPLATES["èƒ½åŠ›ç‚¹è¯„"][level][0].split('ï¼š')
                template_text = template_parts[1] if len(template_parts) > 1 else template_parts[0]
                feedback.append(f"{i}. {dim}ï¼ˆ{score}åˆ†ï¼Œ{level}ï¼‰ï¼š{template_text}")
            else:
                feedback.append(f"{i}. {dim}ï¼ˆ{score}åˆ†ï¼Œ{level}ï¼‰ï¼šéœ€è¦åŠ å¼ºè¯¥æ–¹é¢èƒ½åŠ›")

        feedback.append("")
    except Exception as e:
        feedback.append("èƒ½åŠ›ç‚¹è¯„")
        feedback.append("1. æ— æ³•ç”Ÿæˆç‚¹è¯„ï¼Œå­˜åœ¨æ•°æ®é”™è¯¯")
        feedback.append("")
        print(f"èƒ½åŠ›ç‚¹è¯„ç”Ÿæˆé”™è¯¯: {e}")

    # 3. æ”¹è¿›å»ºè®®ï¼ˆåŸºäºæœ€ä½åˆ†ç»´åº¦ï¼‰
    try:
        feedback.append("æ”¹è¿›å»ºè®®")
        # å®‰å…¨è·å–æœ€å·®ç»´åº¦ï¼Œç¡®ä¿åˆ—è¡¨éç©º
        if scores:
            worst_dim = sorted(scores.items(), key=lambda x: x[1])[0][0]
            worst_level = get_score_level(scores[worst_dim])
        else:
            worst_level = "è¾ƒå·®"

        # å®‰å…¨è·å–æ¨¡æ¿å†…å®¹
        if worst_level in FEEDBACK_TEMPLATES["æ”¹è¿›å»ºè®®"]:
            feedback.extend(FEEDBACK_TEMPLATES["æ”¹è¿›å»ºè®®"][worst_level])
        else:
            feedback.extend(FEEDBACK_TEMPLATES["æ”¹è¿›å»ºè®®"]["è¾ƒå·®"])
        feedback.append("")
    except Exception as e:
        feedback.append("æ”¹è¿›å»ºè®®")
        feedback.append("1. æ— æ³•ç”Ÿæˆå»ºè®®ï¼Œå­˜åœ¨æ•°æ®é”™è¯¯")
        feedback.append("")
        print(f"æ”¹è¿›å»ºè®®ç”Ÿæˆé”™è¯¯: {e}")

    # 4. æ¨èèµ„æºï¼ˆåŸºäºæ•´ä½“åˆ†æ•°æ°´å¹³ï¼‰
    try:
        feedback.append("æ¨èèµ„æº")
        if scores:
            avg_score = sum(scores.values()) / len(scores)
            avg_level = get_score_level(int(avg_score))
        else:
            avg_level = "è¾ƒå·®"

        # å®‰å…¨è·å–æ¨¡æ¿å†…å®¹
        if avg_level in FEEDBACK_TEMPLATES["æ¨èèµ„æº"]:
            feedback.extend(FEEDBACK_TEMPLATES["æ¨èèµ„æº"][avg_level])
        else:
            feedback.extend(FEEDBACK_TEMPLATES["æ¨èèµ„æº"]["è¾ƒå·®"])
    except Exception as e:
        feedback.append("æ¨èèµ„æº")
        feedback.append("1. æ— æ³•ç”Ÿæˆæ¨èï¼Œå­˜åœ¨æ•°æ®é”™è¯¯")
        print(f"æ¨èèµ„æºç”Ÿæˆé”™è¯¯: {e}")

    return feedback
